name: Mirror to Personal Repo

on: [push]

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Debug information
        run: |
          echo "Current directory: $(pwd)"
          echo "Git branches:"
          git branch -a
          echo "Git remotes:"
          git remote -v
      
      - name: Test token authentication
        env:
          TOKEN: ${{ secrets.PERSONAL_REPO_TOKEN }}
        run: |
          # Test token with GitHub API
          echo "Testing token authentication..."
          RESPONSE=$(curl -s -H "Authorization: token ${TOKEN}" \
                         -H "Accept: application/vnd.github.v3+json" \
                         https://api.github.com/user)
          
          if echo "$RESPONSE" | grep -q "login"; then
            echo "✅ Token is valid!"
            echo "Authenticated as: $(echo "$RESPONSE" | grep -o '"login": "[^"]*' | cut -d'"' -f4)"
          else
            echo "❌ Token is invalid or has insufficient permissions"
            echo "Response: $RESPONSE"
            exit 1
          fi
      
      - name: Push to personal repository
        env:
          TOKEN: ${{ secrets.PERSONAL_REPO_TOKEN }}
        run: |
          git remote add personal https://MarcoAtefCosman:${TOKEN}@github.com/MarcoAtefCosman/autonomous-navigation-robile.git
          git push --tags --force --prune personal "refs/remotes/origin/*:refs/heads/*"
